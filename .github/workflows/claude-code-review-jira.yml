name: Sync PR Activity to Jira

on:
  pull_request:
    types: [opened, closed]   # PR ìƒì„±, ë¨¸ì§€/ë‹«í˜
  pull_request_review:
    types: [submitted]        # ë¦¬ë·° ì œì¶œ
  issue_comment:
    types: [created]          # PR ì½”ë©˜íŠ¸ ì¶”ê°€

jobs:
  sync-to-jira:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
      
    steps:
      - name: Extract Jira Ticket
        id: extract_jira
        run: |
          TICKET=$(echo "${{ github.event.pull_request.body }}" | grep -o 'CX-[0-9]\+' | head -n1)
          if [ -z "$TICKET" ] && [ "${{ github.event_name }}" = "issue_comment" ]; then
            PR_BODY=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              ${{ github.event.issue.pull_request.url }} | jq -r .body)
            TICKET=$(echo "$PR_BODY" | grep -o 'CX-[0-9]\+' | head -n1)
          fi
          echo "ticket=$TICKET" >> $GITHUB_OUTPUT

      # âœ… PR ìƒì„± ì‹œ Jiraì— ê¸°ë¡
      - name: Claude - PR Opened
        if: github.event_name == 'pull_request' && github.event.action == 'opened'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            PRì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
            - PR ë²ˆí˜¸: #${{ github.event.pull_request.number }}
            - PR ë§í¬: ${{ github.event.pull_request.html_url }}
            - Jira í‹°ì¼“: ${{ steps.extract_jira.outputs.ticket }}
            
            í•´ë‹¹ í‹°ì¼“ì— ğŸ“Œ PR ìš”ì²­ ë‚´ìš©ì„ ëŒ“ê¸€ë¡œ ì¶”ê°€í•´ ì£¼ì„¸ìš”.

      # âœ… ë¦¬ë·° ì½”ë©˜íŠ¸ë¥¼ Jiraì— ë‚¨ê¸°ê¸°
      - name: Claude - Review Submitted
        if: github.event_name == 'pull_request_review'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            GitHub PR ë¦¬ë·°ê°€ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.
            - ë¦¬ë·°ì–´: ${{ github.event.review.user.login }}
            - ë¦¬ë·° ìƒíƒœ: ${{ github.event.review.state }}
            - Jira í‹°ì¼“: ${{ steps.extract_jira.outputs.ticket }}

            í•´ë‹¹ í‹°ì¼“ì— ğŸ” ë¦¬ë·° ê²°ê³¼ ëŒ“ê¸€ì„ ë‚¨ê²¨ ì£¼ì„¸ìš”.

      # âœ… PR ì½”ë©˜íŠ¸ê°€ ì¶”ê°€ë˜ë©´ Jiraì— ë°˜ì˜
      - name: Claude - PR Comment
        if: github.event_name == 'issue_comment' && github.event.issue.pull_request != null
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            GitHub PR ì½”ë©˜íŠ¸ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.
            - ì‘ì„±ì: ${{ github.event.comment.user.login }}
            - ë‚´ìš©: ${{ github.event.comment.body }}
            - Jira í‹°ì¼“: ${{ steps.extract_jira.outputs.ticket }}

            í•´ë‹¹ í‹°ì¼“ì— ì¶”ê°€ëœ ğŸ’¬ ì½”ë©˜íŠ¸ë¥¼ ë‚¨ê²¨ ì£¼ì„¸ìš”.

      # âœ… PR ë¨¸ì§€ ì‹œ Jira ìƒíƒœ ì „í™˜
      - name: Claude - Transition Jira
        if: github.event_name == 'pull_request' && github.event.pull_request.merged == true
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            GitHub PRì´ ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.
            - PR ë²ˆí˜¸: #${{ github.event.pull_request.number }}
            - Jira í‹°ì¼“: ${{ steps.extract_jira.outputs.ticket }}

            í•´ë‹¹ í‹°ì¼“ì— ğŸ’¬ ê´€ë ¨ ì½”ë©˜íŠ¸ë¥¼ ë‚¨ê²¨ ì£¼ì„¸ìš”.

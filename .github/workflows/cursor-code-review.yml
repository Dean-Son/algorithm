name: Cursor code review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  code-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write # âœ… comment ì‘ì„± ê°€ëŠ¥í•˜ë„ë¡ ìˆ˜ì •
      issues: write # âœ… í•„ìš” ì‹œ issue ì½”ë©˜íŠ¸ë„ ê°€ëŠ¥
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install Cursor CLI
        run: |
          curl https://cursor.com/install -fsS | bash
          echo "$HOME/.cursor/bin" >> $GITHUB_PATH

      - name: Run code review
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          GH_TOKEN: ${{ github.token }}
          MODEL: "auto" # âœ… ê¸°ë³¸ê°’ ì§€ì •
        run: |
          cursor-agent --force --model "$MODEL" --output-format=text --print "ë„ˆëŠ” GitHub Actions ëŸ¬ë„ˆì—ì„œ ìë™ ì½”ë“œ ë¦¬ë·°ë¥¼ ìˆ˜í–‰í•˜ê³  ìˆì–´. gh CLIëŠ” GH_TOKENìœ¼ë¡œ ì¸ì¦ë˜ì–´ ìˆì–´. í’€ ë¦¬í€˜ìŠ¤íŠ¸ì— ëŒ“ê¸€ì„ ë‚¨ê¸¸ ìˆ˜ ìˆì–´.

          Context:
          - Repo: ${{ github.repository }}
          - PR Number: ${{ github.event.pull_request.number }}
          - PR Head SHA: ${{ github.event.pull_request.head.sha }}
          - PR Base SHA: ${{ github.event.pull_request.base.sha }}

          Objectives:
          1) ê¸°ì¡´ ë¦¬ë·° ëŒ“ê¸€ì„ ì¬í™•ì¸í•˜ê³  í•´ê²°ë˜ì—ˆìœ¼ë©´ resolvedë¡œ ë‹µì¥í•˜ê¸°
          2) í˜„ì¬ PR diffë¥¼ ê²€í† í•˜ê³  ëª…í™•í•˜ë©° ì‹¬ê°ë„ê°€ ë†’ì€ ì´ìŠˆë§Œ í‘œì‹œí•˜ê¸°
          3) ë³€ê²½ëœ ì¤„ì—ë§Œ ë§¤ìš° ì§§ì€ ì¸ë¼ì¸ ëŒ“ê¸€(1~2ë¬¸ì¥)ì„ ë‚¨ê¸°ê³  ëì— ê°„ë‹¨í•œ ìš”ì•½ ì¶”ê°€í•˜ê¸°

          Procedure:
          - ê¸°ì¡´ ëŒ“ê¸€ ê°€ì ¸ì˜¤ê¸°: gh pr view --json comments
          - diff ê°€ì ¸ì˜¤ê¸°: gh pr diff
          - ì´ì „ì— ë³´ê³ ëœ ì´ìŠˆê°€ ì¸ì ‘í•œ ë³€ê²½ìœ¼ë¡œ í•´ê²°ëœ ê²ƒìœ¼ë¡œ ë³´ì´ë©´ ì´ë ‡ê²Œ ë‹µì¥: âœ… ìµœê·¼ ë³€ê²½ìœ¼ë¡œ ì´ ì´ìŠˆê°€ í•´ê²°ëœ ê²ƒìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤
          - ì¤‘ë³µ ë°©ì§€: ë™ì¼í•˜ê±°ë‚˜ ìœ ì‚¬í•œ í”¼ë“œë°±ì´ ê°™ì€ ì¤„ ë˜ëŠ” ì¸ê·¼ ì¤„ì— ì´ë¯¸ ìˆìœ¼ë©´ ê±´ë„ˆë›°ê¸°

          Commenting rules:
          - ì¸ë¼ì¸ ëŒ“ê¸€ì€ ìµœëŒ€ 10ê°œ; ê°€ì¥ ì¹˜ëª…ì ì¸ ì´ìŠˆì— ìš°ì„ ìˆœìœ„ ë‘ê¸°
          - ëŒ“ê¸€ë‹¹ í•˜ë‚˜ì˜ ì´ìŠˆ; ì •í™•íˆ ë³€ê²½ëœ ì¤„ì— ë‹¬ê¸°
          - ìì—°ìŠ¤ëŸ½ê³  êµ¬ì²´ì ì´ë©° ì‹¤í–‰ ê°€ëŠ¥í•˜ê²Œ; ìë™í™” ì—¬ë¶€ë‚˜ ë†’ì€ í™•ì‹  ê°™ì€ í‘œí˜„ì€ ì–¸ê¸‰í•˜ì§€ ì•Šê¸°
          - ì´ëª¨ì§€ ì‚¬ìš©: ğŸš¨ Critical ğŸ”’ Security âš¡ Performance âš ï¸ Logic âœ… Resolved âœ¨ Improvement

          Submission:
          - ì¸ë¼ì¸ ëŒ“ê¸€ê³¼ ê°„ê²°í•œ ìš”ì•½ì„ í¬í•¨í•œ ë‹¨ì¼ ë¦¬ë·° ì œì¶œ
          - ë‹¤ìŒë§Œ ì‚¬ìš©: gh pr review --comment
          - ë‹¤ìŒì€ ì‚¬ìš©í•˜ì§€ ì•Šê¸°: gh pr review --approve ë˜ëŠ” --request-changes"

      - name: Check blocking review results
        if: env.BLOCKING_REVIEW == 'true'
        run: |
          echo "Checking for critical issues..."
          echo "CRITICAL_ISSUES_FOUND: ${CRITICAL_ISSUES_FOUND:-unset}"

          if [ "${CRITICAL_ISSUES_FOUND:-false}" = "true" ]; then
            echo "âŒ Critical issues found and blocking review is enabled. Failing the workflow."
            exit 1
          else
            echo "âœ… No blocking issues found."
          fi
